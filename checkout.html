<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Checkout Produk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background-color: #f9f9f9;
    }
    .container {
      background: white;
      max-width: 500px;
      margin: auto;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; color: #333; }
    .form-group { margin-bottom: 15px; }
    label { font-weight: bold; display: block; margin-bottom: 6px; }
    input[type="text"], select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button, .home-button {
      width: 100%;
      padding: 12px;
      background-color: #28a745;
      border: none;
      color: white;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover, .home-button:hover {
      background-color: #218838;
    }
    .quantity-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .quantity-group button {
      width: 40px;
      padding: 8px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Checkout Produk</h2>

    <form id="checkoutForm">
      <div class="form-group">
        <label for="produk">Produk</label>
        <input type="text" id="produk" name="produk" readonly />
      </div>
      <div class="form-group">
        <label>Jumlah Barang</label>
        <div class="quantity-group">
          <button type="button" id="kurang">-</button>
          <input type="text" id="jumlah" name="jumlah" value="1" readonly style="text-align:center; width:50px;" />
          <button type="button" id="tambah">+</button>
        </div>
      </div>
      <div class="form-group">
        <label for="harga">Harga Satuan</label>
        <input type="text" id="harga" name="harga" readonly />
      </div>
      <div class="form-group">
        <label for="metode">Metode Pembayaran</label>
        <select id="metode" name="metode" required>
          <option value="">Memuat metode...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="nama">Nama Pembeli</label>
        <input type="text" id="nama" name="nama" placeholder="Masukkan nama Anda" required />
      </div>
      <div class="form-group">
        <label for="wa">Nomor WhatsApp</label>
        <input type="text" id="wa" name="wa" placeholder="08xxxxxxxxxx" required />
      </div>

      <div class="form-group">
        <label>Total</label>
        <input type="text" id="total" name="total" readonly />
      </div>

      <button type="submit">Lanjutkan Pembayaran</button>
    </form>
  </div>

  <script>
    // ðŸ”‘ GANTI DENGAN API KEY MILIKMU
    const API_KEY = "VPedia_5n49b5u2swjpryyl";

    const params = new URLSearchParams(window.location.search);
    const produk = params.get("produk") || "Produk Tidak Diketahui";
    const hargaProduk = parseInt(params.get("harga") || "0");

    let jumlah = 1;
    const pajakPersen = 0.005;

    function hitungTotal() {
      const subtotal = hargaProduk * jumlah;
      const pajak = Math.round(subtotal * pajakPersen);
      const total = subtotal + pajak;
      return total;
    }

    function updateHarga() {
      document.getElementById("jumlah").value = jumlah;
      document.getElementById("harga").value = "Rp" + hargaProduk.toLocaleString();
      document.getElementById("total").value = "Rp" + hitungTotal().toLocaleString();
    }

    // Set produk
    document.getElementById("produk").value = produk;
    updateHarga();

    document.getElementById("tambah").onclick = () => { jumlah++; updateHarga(); };
    document.getElementById("kurang").onclick = () => { if (jumlah > 1) { jumlah--; updateHarga(); } };

    // Ambil metode pembayaran dari API
    async function ambilMetodeBayar() {
      const res = await fetch("https://v-pedia.web.id/deposit/metode", {
        headers: { "X-APIKEY": API_KEY }
      });

      const hasil = await res.json();
      const select = document.getElementById("metode");
      select.innerHTML = '<option value="">Pilih Metode</option>';

      if (hasil.status && Array.isArray(hasil.data)) {
        hasil.data.forEach(m => {
          const option = document.createElement("option");
          option.value = m.kode;
          option.textContent = `${m.nama} (${m.kode})`;
          select.appendChild(option);
        });
      } else {
        select.innerHTML = '<option value="">Gagal memuat metode</option>';
      }
    }

    ambilMetodeBayar();

    // Proses submit form
    document.getElementById("checkoutForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const nama = document.getElementById("nama").value;
      const wa = document.getElementById("wa").value;
      const metode = document.getElementById("metode").value;

      const nominal = hitungTotal();
      const reff_id = "INV-" + Date.now();

      const payload = new URLSearchParams({
        api_key: API_KEY,
        reff_id: reff_id,
        nominal: nominal,
        type: "ewallet", // atau bisa dynamic tergantung metode
        metode: metode
      });

      const res = await fetch("https://v-pedia.web.id/deposit/create", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: payload
      });

      const hasil = await res.json();

      if (hasil.status) {
        alert("Transaksi berhasil dibuat. Anda akan diarahkan ke halaman pembayaran.");
        window.location.href = hasil.data.url;
      } else {
        alert("Gagal membuat transaksi: " + hasil.message);
      }
    });
  </script>
</body>
</html>